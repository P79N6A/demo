(function(e,t){"use strict";e(function(){function e(e,t,n,i){return r(e).then(t,n,i)}function n(e,t){this.then=e,this.inspect=t}function r(e){return o(function(t){t(e)})}function i(t){return e(t,l)}function s(){function i(i,s,o){e.resolve=e.resolver.resolve=function(e){return n?r(e):(n=!0,i(e),t)},e.reject=e.resolver.reject=function(e){return n?r(l(e)):(n=!0,s(e),t)},e.notify=e.resolver.notify=function(e){return o(e),e}}var e,t,n;return e={promise:H,resolve:H,reject:H,notify:H,resolver:{resolve:H,reject:H,notify:H}},e.promise=t=u(i),e}function o(e){return u(e,P.PromiseStatus&&P.PromiseStatus())}function u(e,t){function o(e,n,r){var o=u(function(t,o,u){function a(i){i.then(e,n,r).then(t,o,u)}s?s.push(a):B(function(){a(i)})},t&&t.observed());return o}function f(){return i?i.inspect():T()}function p(e){if(!s)return;i=a(e),h(s,i),s=H,t&&i.then(function(){t.fulfilled()},function(e){t.rejected(e)})}function d(e){p(l(e))}function v(e){s&&h(s,c(e))}var r,i,s=[];return r=new n(o,f),e(p,d,v),r}function a(e){return e instanceof n?e:e===Object(e)&&"then"in e?o(function(t,n,r){B(function(){var i=e.then;typeof i=="function"?k(i,e,t,n,r):t(f(e))})}):f(e)}function f(e){var t=new n(function(n){return typeof n=="function"?a(n(e)):t},function(){return S(e)});return t}function l(e){var t=new n(function(n,r){return typeof r=="function"?a(r(e)):t},function(){return x(e)});return t}function c(e){var t=new n(function(n,r,i){return typeof i=="function"?c(i(e)):t});return t}function h(e,t){B(function(){var n,r=0;while(n=e[r++])n(t)})}function p(e){return e&&typeof e.then=="function"}function d(t,n,r,i,s){return e(t,function(t){function u(r,i,s){function d(e){c(e)}function v(e){l(e)}var o,u,a,f,l,c,h,p;h=t.length>>>0,o=Math.max(0,Math.min(n,h)),a=[],u=h-o+1,f=[];if(!o)r(a);else{c=function(e){f.push(e),--u||(l=c=F,i(f))},l=function(e){a.push(e),--o||(l=c=F,r(a))};for(p=0;p<h;++p)p in t&&e(t[p],v,d,s)}}return o(u).then(r,i,s)})}function v(e,t,n,r){function i(e){return t?t(e[0]):e[0]}return d(e,1,i,n,r)}function m(e,t,n,r){return w(e,F).then(t,n,r)}function g(){return w(arguments,F)}function y(e){return w(e,S,x)}function b(e,t){return w(e,t)}function w(t,n,r){return e(t,function(t){function i(i,s,o){function c(t,a){e(t,n,r).then(function(e){u[a]=e,--f||i(u)},s,o)}var u,a,f,l;f=a=t.length>>>0,u=[];if(!f){i(u);return}for(l=0;l<a;l++)l in t?c(t[l],l):--f}return o(i)})}function E(t,n){var r=k(C,arguments,1);return e(t,function(t){var i;return i=t.length,r[0]=function(t,r,s){return e(t,function(t){return e(r,function(e){return n(t,e,s,i)})})},N.apply(t,r)})}function S(e){return{state:"fulfilled",value:e}}function x(e){return{state:"rejected",reason:e}}function T(){return{state:"pending"}}function B(e){A.push(e)===1&&L(j)}function j(){var e,t=0;while(e=A[t++])e();A=[]}function F(e){return e}e.promise=o,e.resolve=r,e.reject=i,e.defer=s,e.join=g,e.all=m,e.map=b,e.reduce=E,e.settle=y,e.any=v,e.some=d,e.isPromise=p,n.prototype={otherwise:function(e){return this.then(H,e)},ensure:function(e){function t(){return r(e())}return this.then(t,t).yield(this)},yield:function(e){return this.then(function(){return e})},spread:function(e){return this.then(function(t){return m(t,function(t){return e.apply(H,t)})})},always:function(e,t){return this.then(e,e,t)}};var N,C,k,L,A,O,M,_,D,P,H;return A=[],P=typeof console!="undefined"?console:e,O=t.setTimeout,L=typeof setImmediate=="function"?setImmediate.bind(t):typeof process=="object"&&process.nextTick?process.nextTick:typeof vertx=="object"?vertx.runOnLoop:function(e){O(e,0)},M=Function.prototype,_=M.call,k=M.bind?_.bind(_):function(e,t){return e.apply(t,C.call(arguments,2))},D=[],C=D.slice,N=D.reduce||function(e){var t,n,r,i,s;s=0,t=Object(this),i=t.length>>>0,n=arguments;if(n.length<=1)for(;;){if(s in t){r=t[s++];break}if(++s>=i)throw new TypeError}else r=n[1];for(;s<i;++s)s in t&&(r=e(r,t[s],s,t));return r},e})})(typeof define=="function"&&define.amd?define:function(e){window.when=e()},this)